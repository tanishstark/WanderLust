<% layout("/layouts/boilerplate") %>
    <script>
        let mapToken = "<%= process.env.MAP_TOKEN %>";
        let coordinates = <%= JSON.stringify(listing.geometry.coordinates) %>;
    </script>

    <body>
        <div class="container-fluid">
            <div class="row mt-4">
                <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
                    <!-- Header Section -->
                    <div class="mb-4">
                        <h1 class="display-5 fw-bold text-dark mb-3">
                            <%= listing.title %>
                        </h1>
                        <div class="d-flex align-items-center text-muted mb-3">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            <span>
                                <%= listing.location %>, <%= listing.country %>
                            </span>
                        </div>
                    </div>

                    <!-- Main Content (No Card Wrapper) -->
                    <div class="position-relative mb-4">
                        <img src="<%= listing.image.url %>" class="rounded shadow-lg w-100"
                            style="height: 400px; object-fit: cover;" alt="Listing Image">

                        <!-- Owner Actions (Floating) -->
                        <% if(currentUser && currentUser._id.equals(listing.owner._id)) { %>
                            <div class="position-absolute top-0 end-0 m-3">
                                <div class="btn-group" role="group">
                                    <a href="/listings/<%=listing._id %>/edit" class="btn btn-light btn-sm shadow-sm">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </a>
                                    <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE"
                                        class="d-inline">
                                        <button type="submit" class="btn btn-danger btn-sm shadow-sm"
                                            onclick="return confirm('Are you sure you want to delete this listing?')">
                                            <i class="fas fa-trash me-1"></i>Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                            <% } %>
                    </div>

                    <!-- Listing Details Section -->
                    <div class="mb-4 p-4 bg-light rounded shadow-sm">
                        <!-- Price and Category Badge -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h3 class="text-success fw-bold mb-1">
                                    ₹<%= typeof listing.price==='number' ? listing.price.toLocaleString("en-IN")
                                        : 'Price not set' %>
                                        <small class="text-muted fs-6">/night</small>
                                </h3>
                                <span class="badge bg-primary rounded-pill">
                                    <%= listing.categories %>
                                </span>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Hosted by</small>
                                <div class="fw-bold text-dark">@<%= listing.owner.username %>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <h5 class="mb-3">About this place</h5>
                            <p class="text-muted lh-lg">
                                <%= listing.description %>
                            </p>
                        </div>
                    </div>

                    <!-- Map Section -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-4">
                            <h4 class="mb-3">
                                <i class="fas fa-map-marked-alt me-2 text-primary"></i>
                                Where you'll be
                            </h4>
                            <div id="map" style="height: 300px; border-radius: 10px;"></div>
                        </div>
                    </div>

                    <!-- Enhanced Reviews Section -->
                    <% if(currentUser) { %>
                        <div class="mb-5">
                            <div class="bg-white p-4 rounded-3 shadow-sm border">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle me-3">
                                        <i class="fas fa-star text-warning fs-4"></i>
                                    </div>
                                    <div>
                                        <h4 class="mb-1 fw-bold">Share Your Experience</h4>
                                        <p class="text-muted mb-0">Help others by leaving an honest review</p>
                                    </div>
                                </div>

                                <form method="post" action="/listings/<%= listing._id %>/reviews"
                                    class="needs-validation" novalidate>
                                    <!-- Rating Section -->
                                    <div class="mb-4">
                                        <label class="form-label fw-semibold mb-3 d-block">
                                            <i class="fas fa-star-half-alt me-2 text-warning"></i>
                                            How would you rate this place?
                                        </label>
                                        <div class="rating-container p-3 bg-light rounded-2">
                                            <fieldset class="starability-slot">
                                                <input type="radio" id="no-rate" class="input-no-rate"
                                                    name="review[rating]" value="1" checked aria-label="No rating." />
                                                <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                                                <label for="first-rate1" title="Terrible" class="rating-label">1
                                                    star</label>
                                                <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                                                <label for="first-rate2" title="Not good" class="rating-label">2
                                                    stars</label>
                                                <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                                                <label for="first-rate3" title="Average" class="rating-label">3
                                                    stars</label>
                                                <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                                                <label for="first-rate4" title="Very good" class="rating-label">4
                                                    stars</label>
                                                <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                                                <label for="first-rate5" title="Amazing" class="rating-label">5
                                                    stars</label>
                                            </fieldset>
                                            <div class="rating-text mt-2">
                                                <small class="text-muted" id="rating-description">Select a
                                                    rating</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Comment Section -->
                                    <div class="mb-4">
                                        <label for="comment" class="form-label fw-semibold mb-2">
                                            <i class="fas fa-comment-dots me-2 text-primary"></i>
                                            Tell us about your stay
                                        </label>
                                        <textarea class="form-control form-control-lg" id="comment"
                                            name="review[comment]" rows="4"
                                            placeholder="What made your experience special? " required
                                            style="resize: vertical;"></textarea>
                                        <div class="form-text">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                Tip: Mention specific details about cleanliness, location, amenities,
                                                and host communication
                                            </small>
                                        </div>
                                        <div class="invalid-feedback">Please share your experience with a comment</div>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="submit" class="btn btn-lg px-4 py-2"
                                            style="background-color: #fe424d; border-color: #fe424d; color: white;">
                                            <i class="fas fa-paper-plane me-2"></i>
                                            Publish Review
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <% } %>

                            <!-- All Reviews Section -->
                            <% if(listing.reviews.length> 0) { %>
                                <div class="mb-5">
                                    <!-- Reviews Header -->
                                    <div class="d-flex align-items-center justify-content-between mb-4">
                                        <div class="d-flex align-items-center">
                                            <div class="bg-info bg-opacity-10 p-3 rounded-circle me-3">
                                                <i class="fas fa-comments text-info fs-4"></i>
                                            </div>
                                            <div>
                                                <h4 class="mb-1 fw-bold">Guest Reviews</h4>
                                                <p class="text-muted mb-0">
                                                    <% let totalRating=listing.reviews.reduce((sum, review)=> sum +
                                                        review.rating, 0);
                                                        let avgRating = (totalRating /
                                                        listing.reviews.length).toFixed(1);
                                                        %>
                                                        <span class="fw-semibold text-warning">
                                                            <%= avgRating %>
                                                        </span>
                                                        <i class="fas fa-star text-warning ms-1 me-2"></i>
                                                        Based on <%= listing.reviews.length %> review<%=
                                                                listing.reviews.length !==1 ? 's' : '' %>
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Sort Options -->
                                        <div class="dropdown">
                                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                                                type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-sort me-1"></i>Sort by
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="sortReviews('newest')">Newest first</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="sortReviews('oldest')">Oldest first</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="sortReviews('highest')">Highest rated</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="sortReviews('lowest')">Lowest rated</a></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- Reviews Grid -->
                                    <div class="row g-4" id="reviews-container">
                                        <% for(let review of listing.reviews) { %>
                                            <div class="col-lg-6 review-item " data-rating="<%= review.rating %>"
                                                data-date="<%= review.createdAt || Date.now() %>">
                                                <div class="card h-100 border-0 shadow-sm hover-shadow ">
                                                    <div class="card-body p-4">
                                                        <!-- Review Header -->
                                                        <div
                                                            class="d-flex justify-content-between align-items-start mb-3 ms-2 mt-2">
                                                            <div class="d-flex align-items-center">
                                                                <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                                                                    style="width: 45px; height: 45px; font-size: 18px; font-weight: bold;">
                                                                    <%= review.author.username.charAt(0).toUpperCase()
                                                                        %>
                                                                </div>
                                                                <div>
                                                                    <h6 class="card-title mb-1 fw-bold">@<%=
                                                                            review.author.username %>
                                                                    </h6>
                                                                    <div class="d-flex align-items-center">
                                                                        <div class="starability-result me-2"
                                                                            data-rating="<%= review.rating %>"></div>
                                                                        <small class="text-muted">
                                                                            <i class="fas fa-calendar-alt me-1"></i>
                                                                            <%= review.createdAt ? new
                                                                                Date(review.createdAt).toLocaleDateString()
                                                                                : 'Recently' %>
                                                                        </small>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Delete Button -->
                                                            <% if(currentUser &&
                                                                (currentUser._id.equals(review.author._id) ||
                                                                currentUser._id.equals(listing.owner._id))) { %>
                                                                <form method="post" class="ms-2"
                                                                    action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                                                                    <button class="btn btn-outline-danger btn-sm"
                                                                        type="submit"
                                                                        onclick="return confirm('Are you sure you want to delete this review?')">
                                                                        <i class="fas fa-trash-alt"></i>
                                                                    </button>
                                                                </form>
                                                                <% } %>
                                                        </div>

                                                        <!-- Review Content -->
                                                        <div class="review-content ms-2 mb-3">
                                                            <p class="card-text text-dark lh-base mb-3">
                                                                <%= review.comment %>
                                                            </p>

                                                            <!-- Review Actions -->
                                                            <div
                                                                class="d-flex align-items-center justify-content-between">

                                                                <small class="text-muted">
                                                                    <i class="fas fa-clock me-1"></i>
                                                                    <%= review.createdAt ? Math.floor((Date.now() - new
                                                                        Date(review.createdAt)) / (1000 * 60 * 60 * 24))
                                                                        + ' days ago' : 'Recently' %>
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <% } %>
                                    </div>

                                    <!-- Load More Button (if needed) -->
                                    <% if(listing.reviews.length> 6) { %>
                                        <div class="text-center mt-4">
                                            <button class="btn btn-outline-primary" id="load-more-reviews">
                                                <i class="fas fa-chevron-down me-2"></i>
                                                Show More Reviews
                                            </button>
                                        </div>
                                        <% } %>
                                </div>
                                <% } %>
                </div>
            </div>
        </div>

        <!-- Custom CSS for enhanced styling -->
        <style>
            .hover-shadow {
                transition: box-shadow 0.3s ease;
            }

            .hover-shadow:hover {
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
            }

            .rating-container {
                transition: background-color 0.3s ease;
            }

            .rating-container:hover {
                background-color: #f8f9fa !important;
            }

            .review-content {
                position: relative;
            }

            .avatar-circle {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .form-control:focus {
                border-color: #e6374b;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            }

            .btn[style*="#fe424d"]:hover {
                background-color: #e6374b !important;
                border-color: #e6374b !important;
            }
        </style>

        <!-- JavaScript for enhanced functionality -->
        <script>
            // Rating description update
            document.addEventListener('DOMContentLoaded', function () {
                const ratingInputs = document.querySelectorAll('input[name="review[rating]"]');
                const ratingDescription = document.getElementById('rating-description');

                const descriptions = {
                    '1': '😞 Terrible - Had major issues',
                    '2': '😕 Not good - Below expectations',
                    '3': '😐 Average - It was okay',
                    '4': '😊 Very good - Enjoyed the stay',
                    '5': '😍 Amazing - Exceeded expectations'
                };

                ratingInputs.forEach(input => {
                    input.addEventListener('change', function () {
                        if (this.value && descriptions[this.value]) {
                            ratingDescription.textContent = descriptions[this.value];
                            ratingDescription.style.color = '#28a745';
                        }
                    });
                });
            });

            // Sort reviews functionality
            function sortReviews(criteria) {
                const container = document.getElementById('reviews-container');
                const reviews = Array.from(container.children);

                reviews.sort((a, b) => {
                    switch (criteria) {
                        case 'newest':
                            return new Date(b.dataset.date) - new Date(a.dataset.date);
                        case 'oldest':
                            return new Date(a.dataset.date) - new Date(b.dataset.date);
                        case 'highest':
                            return parseInt(b.dataset.rating) - parseInt(a.dataset.rating);
                        case 'lowest':
                            return parseInt(a.dataset.rating) - parseInt(b.dataset.rating);
                        default:
                            return 0;
                    }
                });

                // Re-append sorted reviews
                reviews.forEach(review => container.appendChild(review));
            }

            // Load more reviews functionality
            document.addEventListener('DOMContentLoaded', function () {
                const loadMoreBtn = document.getElementById('load-more-reviews');
                if (loadMoreBtn) {
                    const reviewItems = document.querySelectorAll('.review-item');
                    const itemsPerPage = 6;
                    let currentPage = 1;

                    // Initially hide reviews beyond first page
                    reviewItems.forEach((item, index) => {
                        if (index >= itemsPerPage) {
                            item.style.display = 'none';
                        }
                    });

                    loadMoreBtn.addEventListener('click', function () {
                        const start = currentPage * itemsPerPage;
                        const end = start + itemsPerPage;

                        for (let i = start; i < end && i < reviewItems.length; i++) {
                            reviewItems[i].style.display = 'block';
                        }

                        currentPage++;

                        if (end >= reviewItems.length) {
                            loadMoreBtn.style.display = 'none';
                        }
                    });
                }
            });
        </script>

        <script src="/js/map.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
            integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
            crossorigin="anonymous"></script>
    </body>